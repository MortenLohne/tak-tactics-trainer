<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tak tactics trainer</title>
    <h1 align="center">Find the best move!</h1>

    <style media="screen">
        body {
            margin: 0;
            padding: 30px;
            font-family: sans-serif;
        }

        .row {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: stretch;
        }

        body>.row {
            flex-grow: 1;
            min-width: 200px;
            flex-wrap: wrap;
            margin-top: 1em;
        }

        body>.row>* {
            flex-grow: 1;
            min-width: 200px;
        }

        .row input,
        .row textarea {
            width: 100% !important;
            margin-bottom: 1em;
        }

        #sendMessage,
        #clearOutput {
            position: sticky;
            top: 1em;
        }

        #output {
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <iframe id="ninja"
        src="https://ptn.ninja/&showPlayButton=false&disablePTN=true&disableText=true&showBoardPrefsBtn=true"
        width="100%" height="600px" style="width: 100%; height: 600px; max-height: 100vh" frameborder="0"
        allowfullscreen></iframe>
    <div id="puzzleSolved" style="display: none;">
        <h2>Puzzle Solved!</h2>
        <p>Congratulations! You have successfully solved the puzzle.</p>
        <button id="nextPuzzleSuccess">Next
            puzzle</button>
    </div>
    <div id="puzzleFailed" style="display: none;">
        <h2>Puzzle Failed</h2>
        <p>Unfortunately, you did not solve the puzzle correctly.</p>
        <button id="nextPuzzleFailed">Next
            puzzle</button>
        <button id="retryPuzzle" onclick="switchPuzzle()">Retry Puzzle</button>
    </div>
    <div class="row" style="display: none;">
        <fieldset>
            <legend>Send Message</legend>
            <form id=" sendMessage" method="post">
                <input name="action" placeholder="Action" />
                <textarea name="value" placeholder="Value"></textarea>
                <div class="row">
                    <input type="reset" value="Clear" />
                    <input type="submit" value="Send" />
                </div>
            </form>
        </fieldset>

        <fieldset>
            <legend>Received Messages</legend>
            <input id="clearOutput" type="button" value="Clear" onclick="output.value = ''" />
            <output id="output"></output>
        </fieldset>
    </div>

    <script type="text/javascript">
        const form = document.getElementById("sendMessage");
        let ptnNinjaHasLoaded = false;
        let messagesReceived = 0;
        let currentPuzzleIndex = 0;
        let allPuzzles = [];
        let currentPuzzle;
        let currentPuzzlePly = 0;

        const nextPuzzle = () => {
            currentPuzzleIndex += 1;
            if (currentPuzzleIndex >= allPuzzles.length) {
                currentPuzzleIndex = 0; // Loop back to the first puzzle
            }
            currentPuzzle = allPuzzles[currentPuzzleIndex];
            switchPuzzle();
        }
        const nextPuzzleSuccessButton = document.getElementById("nextPuzzleSuccess");
        nextPuzzleSuccessButton.addEventListener("click", () => {
            nextPuzzle();
        });
        const nextPuzzleFailedButton = document.getElementById("nextPuzzleFailed");
        nextPuzzleFailedButton.addEventListener("click", () => {
            nextPuzzle();
        });

        const switchPuzzle = () => {
            currentPuzzlePly = 0;
            document.getElementById('puzzleFailed').style.display = 'none';
            document.getElementById('puzzleSolved').style.display = 'none';

            const tpsWords = currentPuzzle.rootTPS.split(' ');
            const moveNumber = tpsWords[tpsWords.length - 1];

            const ninja = document.getElementById("ninja");

            const ptn = `[Size "${currentPuzzle.size}"]
            [Komi "${currentPuzzle.komi}"]
            [TPS "${currentPuzzle.rootTPS}"]
            [Player1 "${currentPuzzle.playerWhite}"]
            [Player2 "${currentPuzzle.playerBlack}"]
${moveNumber}. ${currentPuzzle.defenderStartMove}
            `;

            ninja.contentWindow.postMessage({
                action: 'SET_CURRENT_PTN',
                value: ptn
            }, '*');
            ninja.contentWindow.postMessage({
                action: 'LAST',
            }, '*');
        }

        const initPuzzles = () => {
            fetch('puzzles.json')
                .then(response => response.json())
                .then(puzzles => {
                    console.log(`${puzzles.length} puzzles loaded`);
                    allPuzzles = puzzles;
                    currentPuzzle = puzzles[0];
                    switchPuzzle();
                })
                .catch(error => {
                    console.error('Error fetching puzzles:', error);
                });
        };
        window.addEventListener(
            "message",
            (event) => {
                if (event.source !== ninja.contentWindow) {
                    return
                }
                messagesReceived += 1;
                document.getElementById("output").value +=
                    "" + messagesReceived + " messages received,\n" + JSON.stringify(event.data, null, 2) + "\n";

                // Consider the PTN ninja embed loaded after first GAME_STATE message
                // Only initialize puzzles after this point
                if (!ptnNinjaHasLoaded) {
                    if (event.data.action === "GAME_STATE") {
                        ptnNinjaHasLoaded = true;
                        initPuzzles();
                    } else {
                        return; // Ignore other messages until ptn.ninja is fully loaded
                    }
                }
                if (event.data.action === "PREV") {
                    currentPuzzlePly -= 1;
                    // Don't allow skipping past the defender's initial move
                    if (currentPuzzlePly === -1) {
                        ninja.contentWindow.postMessage({
                            action: 'NEXT',
                            value: ""
                        }, '*');
                    }
                }
                if (event.data.action === "FIRST") {
                    currentPuzzlePly = -1;
                    // Immediately insert the defender's initial move
                    ninja.contentWindow.postMessage({
                        action: 'NEXT',
                        value: ""
                    }, '*');
                }
                if (event.data.action === "NEXT") {
                    currentPuzzlePly += 1;
                    // Skip past the defender's move
                    if (currentPuzzlePly % 2 === 1 && currentPuzzlePly < currentPuzzle.solution.length) {
                        ninja.contentWindow.postMessage({
                            action: 'INSERT_PLY',
                            value: currentPuzzle.solution[currentPuzzlePly]
                        }, '*');
                    }
                }
                if (event.data.action === "INSERT_PLY") {
                    if (event.data.value.replaceAll("*", "") === currentPuzzle.solution[currentPuzzlePly]) {
                        if (currentPuzzlePly === currentPuzzle.solution.length - 1) {
                            // Puzzle solved
                            document.getElementById("puzzleSolved").style.display = "block";
                            ninja.contentWindow.postMessage({
                                action: 'NOTIFY_SUCCESS',
                                value: { message: `Puzzle solved!`, timeout: 5000 }
                            }, '*');
                        }
                        else if (currentPuzzlePly % 2 === 0) {
                            // Even ply are the player's moves
                            ninja.contentWindow.postMessage({
                                action: 'NOTIFY_SUCCESS',
                                value: { message: `Correct move: ${event.data.value} `, timeout: 2000 }
                            }, '*');
                            // Wait before inserting the next ply
                            setTimeout(() => {
                                ninja.contentWindow.postMessage({
                                    action: 'INSERT_PLY',
                                    value: currentPuzzle.solution[currentPuzzlePly]
                                }, '*');
                            }, 200);
                        } else {
                            // Odd ply are the opponent's moves
                        }
                    } else {
                        document.getElementById("puzzleFailed").style.display = "block";
                        ninja.contentWindow.postMessage({
                            action: 'NOTIFY_ERROR',
                            value: { message: `Incorrect move: ${event.data.value}`, timeout: 2000 }
                        }, '*');
                    }
                    currentPuzzlePly += 1;
                }
            },
            false
        );

        form.addEventListener(
            "submit",
            (event) => {
                event.preventDefault();
                const ninja = document.getElementById("ninja");
                const data = new FormData(event.target);
                const action = data.get("action");
                const valueString = data.get("value");
                let value;
                try {
                    value = JSON.parse(valueString);
                } catch (error) {
                    value = valueString;
                }
                try {
                    ninja.contentWindow.postMessage({ action, value }, "*");
                } catch (error) {
                    console.error(error);
                }
                return false;
            },
            true
        );

    </script>
</body>

</html>